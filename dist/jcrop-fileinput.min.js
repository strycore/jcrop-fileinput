/*
 *  jQuery Boilerplate - v0.0.1
 *  A jump-start for jQuery plugins development.
 *  http://github.com/strycore/jcrop-fileinput
 *
 *  Made by Mathieu Comandon
 *  Under MIT License
 */
(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};!function(b,c,d){var e,f,g;return g="JCropFileInput",f={ratio:void 0,jcrop_width:640,jcrop_height:480,scale_height:void 0,scale_width:void 0,min_width:void 0,min_height:void 0,max_height:9999,max_width:9999,save_callback:void 0,delete_callback:void 0,invalid_callback:void 0,show_crop_button:!1,show_delete_button:!1,debug:!1,labels:{upload:"Upload an image",change:"Modify image","delete":"Delete image",crop:"Crop",save:"Save"}},e=function(){function c(c,d){this.element=c,this.on_jcrop_select=a(this.on_jcrop_select,this),this.set_blob=a(this.set_blob,this),this.on_image_ready=a(this.on_image_ready,this),this.on_save=a(this.on_save,this),this.on_uploaded_image_load=a(this.on_uploaded_image_load,this),this.on_fileinput_change=a(this.on_fileinput_change,this),this.on_delete_click=a(this.on_delete_click,this),this.on_crop_click=a(this.on_crop_click,this),this.on_initial_ready=a(this.on_initial_ready,this),this.options=b.extend({},f,d),this._defaults=f,this._name=g,this.init()}return c.prototype.init=function(){var a,c,e,f,g,h,i,j;return this.blob=new Blob,this.element.JCropFileInput=this,b(this.element).on("change",this.on_fileinput_change),this.options.save_callback||this.override_form_submit(),i=d.createElement("div"),i.className="jcrop-fileinput-actions",b(this.element).wrap(i),this.buttons=b(this.element).parent(),j=d.createElement("div"),j.className="jcrop-fileinput-wrapper",b(this.buttons).wrap(j),this.controls_root=b(this.buttons).parent(),g=b("<span></span>"),g.addClass("jcrop-fileinput-upload-label"),g.text(this.options.labels.upload),f=b("<span></span>"),f.addClass("jcrop-fileinput-fakebutton"),f.addClass("jcrop-fileinput-button"),b(this.element).wrap(f),b(this.element).before(g),a=b("<button>"+this.options.labels.crop+"</button>"),a.addClass("jcrop-fileinput-button"),a.addClass("jcrop-fileinput-crop-button"),a.on("click",this.on_crop_click),this.options.show_crop_button||a.hide(),b(this.buttons).prepend(a),c=b("<button>"+this.options.labels["delete"]+"</button>"),c.addClass("jcrop-fileinput-button"),c.addClass("jcrop-fileinput-delete-button"),c.on("click",this.on_delete_click),this.options.show_delete_button||c.hide(),b(this.buttons).append(c),e=b("<div></div>"),e.addClass("jcrop-fileinput-status"),this.controls_root.prepend(e),b(this.element).attr("data-initial")?(h=b(this.element).attr("data-initial"),this.build_image(h,this.on_initial_ready),this.set_image_uploaded(!0)):this.set_image_uploaded(!1),this.widgetContainer=b("<div>"),this.widgetContainer.addClass("jcrop-fileinput-container"),this.controls_root.after(this.widgetContainer),this.targetCanvas=d.createElement("canvas")},c.prototype.on_initial_ready=function(a){return this.original_image=a,this.original_width=a.width,this.original_height=a.height,this.targetCanvas.width=a.width,this.targetCanvas.height=a.height,this.set_status_text(a.src,a.width,a.height),this.add_thumbnail(a)},c.prototype.add_thumbnail=function(a){var c,e,f,g,h;return this.controls_root.find(".jcrop-fileinput-thumbnail").remove(),g=this.get_max_size(a.width,a.height,50,50),h=this.get_resized_image(a,g.width,g.height),f=d.createElement("div"),f.className="jcrop-fileinput-thumbnail",c=b("<img>"),c.prop("src",h),c.on("click",this.on_crop_click),c.wrap(f),e=c.parent(),this.controls_root.prepend(e)},c.prototype.on_crop_click=function(a){return a.preventDefault(),this.build_jcrop_widget(this.original_image)},c.prototype.on_delete_click=function(a){return a.preventDefault(),this.set_image_uploaded(!1),this.options.delete_callback?this.options.delete_callback():void 0},c.prototype.on_fileinput_change=function(a){var b,c,d,e=this;return b=a.target.files[0],b||this.debug("No file given"),c=b.name,d=new FileReader,d.onloadend=function(){return e.controls_root.find(".jcrop-fileinput-delete-button").show(),e.controls_root.find(".jcrop-fileinput-upload-label").text(e.options.labels.change),e.is_canvas_supported()?(e.controls_root.find(".jcrop-fileinput-crop-button").show(),e.original_filetype=b.type,e.original_image=e.build_image(d.result,e.on_uploaded_image_load),e.set_status_text(c,e.original_image.width,e.original_image.height)):e.options.save_callback?e.options.save_callback(d.result):void 0},d.readAsDataURL(b)},c.prototype.on_uploaded_image_load=function(a){return this.original_width=a.width,this.original_height=a.height,this.build_jcrop_widget(a)},c.prototype.on_save=function(a){var b;return a.preventDefault(),b=this.targetCanvas.toDataURL(this.original_filetype),this.jcrop_api.destroy(),this.controls_root.slideDown(),this.widgetContainer.empty(),this.build_image(b,this.on_image_ready)},c.prototype.on_image_ready=function(a){var b,c,d,e;return this.add_thumbnail(a),this.set_image_uploaded(!0),c=a.src,this.options.scale_width&&this.options.scale_height?(e=this.options.scale_width,b=this.options.scale_height):this.options.max_width||this.options.max_height?(d=this.get_max_size(a.width,a.height,this.options.max_width,this.options.max_height),e=d.width,b=d.height):(e=a.width,b=a.height),c=this.get_resized_image(a,e,b),e<this.options.min_width||b<this.options.min_height?(this.controls_root.addClass("jcrop-fileinput-invalid"),this.options.invalid_callback&&this.options.invalid_callback()):this.controls_root.removeClass("jcrop-fileinput-invalid"),this.targetCanvas.toBlob(this.set_blob),this.options.save_callback?this.options.save_callback(c):void 0},c.prototype.is_canvas_supported=function(){var a;return a=d.createElement("canvas"),!(!a.getContext||!a.getContext("2d"))},c.prototype.set_image_uploaded=function(a){return a?(this.controls_root.find(".jcrop-fileinput-upload-label").text(this.options.labels.change),this.controls_root.addClass("jcrop-fileinput-has-file")):(this.controls_root.removeClass("jcrop-fileinput-has-file"),this.controls_root.find(".jcrop-fileinput-thumbnail").remove(),this.controls_root.find(".jcrop-fileinput-delete-button").hide(),this.controls_root.find(".jcrop-fileinput-crop-button").hide(),this.controls_root.find(".jcrop-fileinput-upload-label").text(this.options.labels.upload),this.set_status_text(null))},c.prototype.build_image=function(a,b){var c;return c=d.createElement("img"),c.src=a,c.onload=function(){return b?b(c):void 0},c},c.prototype.set_blob=function(a){return this.blob=a},c.prototype.build_toolbar=function(){var a,c;return c=b("<div>").addClass("jcrop-fileinput-toolbar"),a=b("<button>"+this.options.labels.save+"</button>"),a.addClass("jcrop-fileinput-button"),a.on("click",this.on_save),c.append(a)},c.prototype.set_status_text=function(a,c,d){var e,f,g,h,i;return i=this.controls_root.find(".jcrop-fileinput-status"),i.empty(),a?(f=a.split("/"),a=f[f.length-1],e=b("<span>").addClass("jcrop-fileinput-filename").text(a),e.prop("title",a),h="("+c+"x"+d+"px)",g=b("<span>").addClass("jcrop-fileinput-size").text(h),i.append(e),i.append(g)):void 0},c.prototype.get_resized_image=function(a,b,c){var e,f,g,h;return b&&c?(this.debug("Resizing image to "+b+"x"+c),g=b,f=c,e=d.createElement("canvas"),e.width=g,e.height=f,h=e.getContext("2d"),h.drawImage(a,0,0,b,c),e.toDataURL(this.original_filetype)):(this.debug("Missing image dimensions"),void 0)},c.prototype.get_max_size=function(a,b,c,d){var e,f;return f=a,e=b,a>b?a>c&&(e*=c/a,f=c):b>d&&(f*=d/b,e=d),{width:f,height:e}},c.prototype.build_jcrop_widget=function(a){var c,d,e,f;return this.debug("initalizing jcrop "),f=this.get_max_size(a.width,a.height,this.options.jcrop_width,this.options.jcrop_height),d=this.get_resized_image(a,f.width,f.height),this.controls_root.slideUp(),e=this,this.widgetContainer.find(".jcrop-image").remove(),this.widgetContainer.find(".jcrop-fileinput-toolbar").remove(),c=b("<img>"),c.prop("src",d),c.addClass("jcrop-image"),this.widgetContainer.append(c),this.widgetContainer.append(this.build_toolbar()),this.widgetContainer.slideDown(),c.Jcrop({onChange:this.on_jcrop_select,onSelect:this.on_jcrop_select,aspectRatio:this.options.ratio,bgColor:"white",bgOpacity:.5},function(){var a;return a=this,a.setSelect([0,0,c.width(),c.height()]),e.jcrop_api=a})},c.prototype.on_jcrop_select=function(a){return this.crop_original_image(a)},c.prototype.crop_original_image=function(a){var b,c,d,e,f,g,h;if(a)return f=this.original_width>this.options.jcrop_width||this.original_height>this.options.jcrop_height?this.original_width>this.original_height?this.original_width/this.options.jcrop_width:this.original_height/this.options.jcrop_height:1,b=this.targetCanvas,g=a.x*f,h=a.y*f,d=a.w*f,c=a.h*f,b.width=d,b.height=c,e=b.getContext("2d"),e.drawImage(this.original_image,g,h,d,c,0,0,d,c)},c.prototype.override_form_submit=function(){var a,c=this;return(a=b(this.element).closest("form").get(0))?b(a).on("submit",function(b){var e,f,g,h,i,j,k,l,m,n;for(b.preventDefault(),h=new FormData,console.log(a),i=m=0,n=a.length;n>=0?n>=m:m>=n;i=n>=0?++m:--m)f=a[i],f&&(g=f.name,g&&(j=f.JCropFileInput,j||(l=f.value,h.append(g,l))));return h.append("image",c.blob,"image.png"),k=new XMLHttpRequest,e=a.action||".",k.open("POST",e),k.send(h),k.onload=function(){return d.open(),d.write(k.responseText),d.close()}}):void 0},c.prototype.debug=function(a){return this.options.debug?console.log(a):void 0},c.prototype.set_options=function(a){return this.options=b.extend({},this.options,a),this.set_ratio(this.options.ratio)},c.prototype.set_ratio=function(a){return this.jcrop_api?this.jcrop_api.setOptions({aspectRatio:a}):void 0},c}(),b.fn[g]=function(a){return this.each(function(){var c;return b.data(this,"plugin_"+g)?(c=b.data(this,"plugin_"+g),c.set_options(a)):b.data(this,"plugin_"+g,new e(this,a))})}}(jQuery,window,document)}).call(this);