/*
 *  jQuery Boilerplate - v0.0.1
 *  A jump-start for jQuery plugins development.
 *  http://github.com/strycore/jcrop-fileinput
 *
 *  Made by Mathieu Comandon
 *  Under MIT License
 */
(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};!function(b,c,d){var e,f,g;return g="JCropFileInput",f={ratio:void 0,jcropWidth:640,jcropHeight:480,scaleHeight:void 0,scaleWidth:void 0,minWidth:void 0,minHeight:void 0,maxHeight:9999,maxWidth:9999,thumbMaxWidth:50,thumbMaxHeight:50,saveCallback:void 0,onSubmit:function(){},deleteCallback:void 0,invalidCallback:void 0,showCropButton:!1,showDeleteButton:!1,debug:!1,labels:{upload:"Upload an image",change:"Modify image","delete":"Delete image",crop:"Crop",save:"Save"}},e=function(){function e(c,d){this.element=c,this.onJcropSelect=a(this.onJcropSelect,this),this.setBlob=a(this.setBlob,this),this.onImageReady=a(this.onImageReady,this),this.onSave=a(this.onSave,this),this.onUploadedImageLoad=a(this.onUploadedImageLoad,this),this.onFileinputChange=a(this.onFileinputChange,this),this.onDeleteClick=a(this.onDeleteClick,this),this.onCropClick=a(this.onCropClick,this),this.onInitialReady=a(this.onInitialReady,this),this.options=b.extend({},f,d),this.defaults=f,this.name=g,this.init()}return e.prototype.init=function(){var a,e,f,g,h,i,j,k;return c.Blob?this.blob=new Blob:this.blob=null,this.element.JCropFileInput=this,b(this.element).on("change",this.onFileinputChange),this.options.saveCallback||this.overrideFormSubmit(),i=d.createElement("div"),i.className="jcrop-fileinput-actions",b(this.element).wrap(i),this.buttons=b(this.element).parent(),j=d.createElement("div"),j.className="jcrop-fileinput-wrapper",b(this.buttons).wrap(j),this.controlsRoot=b(this.buttons).parent(),h=b("<span></span>"),h.addClass("jcrop-fileinput-upload-label"),h.text(this.options.labels.upload),g=b("<span></span>"),g.addClass("jcrop-fileinput-fakebutton"),g.addClass("jcrop-fileinput-button"),b(this.element).wrap(g),b(this.element).before(h),a=b("<button>"+this.options.labels.crop+"</button>"),a.addClass("jcrop-fileinput-button"),a.addClass("jcrop-fileinput-crop-button"),a.on("click",this.onCropClick),this.options.showCropButton||a.hide(),b(this.buttons).prepend(a),e=b("<button>"+this.options.labels["delete"]+"</button>"),e.addClass("jcrop-fileinput-button"),e.addClass("jcrop-fileinput-delete-button"),e.on("click",this.onDeleteClick),this.options.showDeleteButton||e.hide(),b(this.buttons).append(e),f=b("<div></div>"),f.addClass("jcrop-fileinput-status"),this.controlsRoot.prepend(f),b(this.element).attr("data-initial")?(k=b(this.element).attr("data-initial"),this.buildImage(k,this.onInitialReady),this.setImageUploaded(!0)):this.setImageUploaded(!1),this.widgetContainer=b("<div>"),this.widgetContainer.addClass("jcrop-fileinput-container"),this.controlsRoot.after(this.widgetContainer),this.targetCanvas=d.createElement("canvas")},e.prototype.onInitialReady=function(a){return this.originalImage=a,this.originalWidth=a.width,this.originalHeight=a.height,this.targetCanvas.width=a.width,this.targetCanvas.height=a.height,this.setStatusText(a.src,a.width,a.height),this.addThumbnail(a)},e.prototype.addThumbnail=function(a){var c,e,f,g,h;return this.controlsRoot.find(".jcrop-fileinput-thumbnail").remove(),g=this.getMaxSize(a.width,a.height,this.options.thumbMaxWidth,this.options.thumbMaxHeight),h=this.getResizedImage(a,g.width,g.height),f=d.createElement("div"),f.className="jcrop-fileinput-thumbnail",c=b("<img>"),c.prop("src",h),c.on("click",this.onCropClick),c.wrap(f),e=c.parent(),this.controlsRoot.prepend(e)},e.prototype.onCropClick=function(a){return a.preventDefault(),this.buildJcropWidget(this.originalImage)},e.prototype.onDeleteClick=function(a){return a.preventDefault(),this.setImageUploaded(!1),this.options.deleteCallback?this.options.deleteCallback():void 0},e.prototype.onFileinputChange=function(a){var b,c,d;return b=a.target.files[0],b||this.debug("No file given"),c=b.name,d=new FileReader,d.onloadend=function(a){return function(){return a.controlsRoot.find(".jcrop-fileinput-delete-button").show(),a.controlsRoot.find(".jcrop-fileinput-upload-label").text(a.options.labels.change),a.isCanvasSupported()?(a.controlsRoot.find(".jcrop-fileinput-crop-button").show(),a.originalFiletype=b.type,a.originalImage=a.buildImage(d.result,a.onUploadedImageLoad),a.setStatusText(c,a.originalImage.width,a.originalImage.height)):a.options.saveCallback?a.options.saveCallback(d.result):void 0}}(this),d.readAsDataURL(b)},e.prototype.onUploadedImageLoad=function(a){return this.originalWidth=a.width,this.originalHeight=a.height,this.buildJcropWidget(a)},e.prototype.onSave=function(a){var b;return a.preventDefault(),b=this.targetCanvas.toDataURL(this.originalFiletype),this.jcropApi.destroy(),this.controlsRoot.slideDown(),this.widgetContainer.empty(),this.buildImage(b,this.onImageReady)},e.prototype.onImageReady=function(a){var b,c,d,e;return this.addThumbnail(a),this.setImageUploaded(!0),c=a.src,this.options.scaleWidth&&this.options.scaleHeight?(e=this.options.scaleWidth,b=this.options.scaleHeight,this.debug("Scale image to "+e+"x"+b)):this.options.maxWidth||this.options.maxHeight?(d=this.getMaxSize(a.width,a.height,this.options.maxWidth,this.options.maxHeight),e=d.width,b=d.height,this.debug("Resized image to "+e+"x"+b)):(e=a.width,b=a.height),c=this.getResizedImage(a,e,b),e<this.options.minWidth||b<this.options.minHeight?(this.controlsRoot.addClass("jcrop-fileinput-invalid"),this.options.invalidCallback&&this.options.invalidCallback(e,b)):this.controlsRoot.removeClass("jcrop-fileinput-invalid"),this.targetCanvas.toBlob(this.setBlob),this.options.saveCallback?this.options.saveCallback(c):void 0},e.prototype.isCanvasSupported=function(){var a;return a=d.createElement("canvas"),!(!a.getContext||!a.getContext("2d"))},e.prototype.setImageUploaded=function(a){return a?(this.controlsRoot.find(".jcrop-fileinput-upload-label").text(this.options.labels.change),this.controlsRoot.addClass("jcrop-fileinput-has-file")):(this.controlsRoot.removeClass("jcrop-fileinput-has-file"),this.controlsRoot.find(".jcrop-fileinput-thumbnail").remove(),this.controlsRoot.find(".jcrop-fileinput-delete-button").hide(),this.controlsRoot.find(".jcrop-fileinput-crop-button").hide(),this.controlsRoot.find(".jcrop-fileinput-upload-label").text(this.options.labels.upload),this.setStatusText(null))},e.prototype.buildImage=function(a,b){var c;return c=d.createElement("img"),c.src=a,c.onload=function(){return b?b(c):void 0},c},e.prototype.setBlob=function(a){return this.blob=a},e.prototype.buildToolbar=function(){var a,c;return c=b("<div>").addClass("jcrop-fileinput-toolbar"),a=b("<button>"+this.options.labels.save+"</button>"),a.addClass("jcrop-fileinput-button"),a.on("click",this.onSave),c.append(a)},e.prototype.setStatusText=function(a,c,d){var e,f,g,h,i,j;return j=this.controlsRoot.find(".jcrop-fileinput-status"),j.empty(),a?(g=a.split("/"),a=g[g.length-1],e="jcrop-fileinput-filename",f=b("<span>").addClass(e).text(a),f.prop("title",a),i="("+c+" x "+d+" px)",h=b("<span>").addClass("jcrop-fileinput-size").text(i),j.append(f),j.append(h)):void 0},e.prototype.getResizedImage=function(a,b,c){var e,f,g,h;return b&&c?(this.debug("Resizing image to "+b+"x"+c),g=b,f=c,e=d.createElement("canvas"),e.width=g,e.height=f,h=e.getContext("2d"),h.drawImage(a,0,0,b,c),e.toDataURL(this.originalFiletype)):void this.debug("Missing image dimensions")},e.prototype.getMaxSize=function(a,b,c,d){var e,f;return f=a,e=b,a>b?a>c&&(e*=c/a,f=c):b>d&&(f*=d/b,e=d),{width:f,height:e}},e.prototype.buildJcropWidget=function(a){var c,d,e,f;return this.debug("initalizing jcrop "),f=this.getMaxSize(a.width,a.height,this.options.jcropWidth,this.options.jcropHeight),d=this.getResizedImage(a,f.width,f.height),this.controlsRoot.slideUp(),e=this,this.widgetContainer.find(".jcrop-image").remove(),this.widgetContainer.find(".jcrop-fileinput-toolbar").remove(),c=b("<img>"),c.prop("src",d),c.addClass("jcrop-image"),this.widgetContainer.append(c),this.widgetContainer.append(this.buildToolbar()),this.widgetContainer.slideDown(),c.Jcrop({onChange:this.onJcropSelect,onSelect:this.onJcropSelect,aspectRatio:this.options.ratio,bgColor:"white",bgOpacity:.5},function(){var a;return a=this,a.setSelect([0,0,c.width(),c.height()]),e.jcropApi=a})},e.prototype.onJcropSelect=function(a){return this.cropOriginalImage(a)},e.prototype.cropOriginalImage=function(a){var b,c,d,e,f,g,h,i,j;if(a)return h=this.originalWidth>this.options.jcropWidth,g=this.originalHeight>this.options.jcropHeight,f=h||g?this.originalWidth>this.originalHeight?this.originalWidth/this.options.jcropWidth:this.originalHeight/this.options.jcropHeight:1,b=this.targetCanvas,i=Math.max(a.x*f,0),j=Math.max(a.y*f,0),d=parseInt(a.w*f),c=parseInt(a.h*f),b.width=d,b.height=c,e=b.getContext("2d"),e.drawImage(this.originalImage,i,j,d,c,0,0,d,c),console.log("humm...")},e.prototype.overrideFormSubmit=function(){console.log("!!!!")},e.prototype.debug=function(a){return this.options.debug?console.log(a):void 0},e.prototype.setOptions=function(a){return this.options=b.extend({},this.options,a),this.setRatio(this.options.ratio)},e.prototype.setRatio=function(a){return this.jcropApi?this.jcropApi.setOptions({aspectRatio:a}):void 0},e}(),b.fn[g]=function(a){return this.each(function(){var c;return b.data(this,"plugin_"+g)?(c=b.data(this,"plugin_"+g),c.setOptions(a)):b.data(this,"plugin_"+g,new e(this,a))})}}(jQuery,window,document)}).call(this);